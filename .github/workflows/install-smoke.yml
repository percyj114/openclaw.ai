name: Install Smoke

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  install-scripts-cross-platform:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: install.sh dry run
        if: runner.os != 'Windows'
        run: bash public/install.sh --dry-run --no-onboard --no-prompt

      - name: install.ps1 dry run
        if: runner.os == 'Windows'
        shell: pwsh
        run: .\\public\\install.ps1 -DryRun -NoOnboard -InstallMethod npm

      - name: install.cmd dry run
        if: runner.os == 'Windows'
        shell: cmd
        run: set "CLAWDBOT_INSTALL_PS1_URL=%GITHUB_WORKSPACE%\\public\\install.ps1" && .\\public\\install.cmd --dry-run --no-onboard --npm

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Install ShellCheck
        run: sudo apt-get update -y && sudo apt-get install -y shellcheck

      - name: ShellCheck
        run: shellcheck $(git ls-files '*.sh')

  install-sh-unit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Unit tests (install.sh)
        run: bash scripts/test-install-sh-unit.sh

  install-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout installer
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Build smoke image (root)
        run: docker build -t clawdbot-install-smoke:ci -f scripts/docker/install-sh-smoke/Dockerfile .

      - name: Run install smoke (root)
        env:
          CLAWDBOT_NO_ONBOARD: "1"
        run: docker run --rm -t -e CLAWDBOT_NO_ONBOARD clawdbot-install-smoke:ci

      - name: Build non-root image
        run: docker build -t clawdbot-install-nonroot:ci -f scripts/docker/install-sh-nonroot/Dockerfile .

      - name: Run install smoke (non-root + CLI)
        env:
          CLAWDBOT_NO_ONBOARD: "1"
        run: |
          docker run --rm -t \
            -e CLAWDBOT_NO_ONBOARD \
            clawdbot-install-nonroot:ci

  install-sh-git-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout installer
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Build git smoke image (install.sh)
        run: docker build -t clawdbot-install-git-smoke:ci -f scripts/docker/install-sh-git-smoke/Dockerfile .

      - name: Run git smoke (install.sh)
        env:
          CLAWDBOT_NO_ONBOARD: "1"
          CLAWDBOT_NO_PROMPT: "1"
        run: docker run --rm -t -e CLAWDBOT_NO_ONBOARD -e CLAWDBOT_NO_PROMPT clawdbot-install-git-smoke:ci

  install-cli-git-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout installer
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Build git smoke image (install-cli.sh)
        run: docker build -t openclaw-install-cli-git-smoke:ci -f scripts/docker/install-cli-git-smoke/Dockerfile .

      - name: Run git smoke (install-cli.sh)
        run: docker run --rm -t openclaw-install-cli-git-smoke:ci
